# 系统目标

## 总体设计

1. gear build指令：将原本的docker镜像构建成gear镜像
2. 

## 详细设计

### 文件夹设置

1. gear主文件夹：/var/lib/gear/
2. private cache文件夹：/var/lib/gear/private/
3. public cache文件夹：/var/lib/gear/public/

4. upperdir文件夹：/var/lib/docker/geargraphdriver/containers/
5. lowerdir文件夹：/var/lib/docker/geargraphdriver/images/
6. 每个镜像的文件夹：/var/lib/docker/geargraphdriver/images/imageID/
7. 每个容器的文件夹：/var/lib/docker/geargraphdriver/containers/containerID/
8. 每个容器的upperdir文件夹：/var/lib/docker/geargraphdriver/containers/containerID/upper/
9. 每个容器的workdir文件夹：/var/lib/docker/geargraphdriver/containers/containerID/work/
10. 每个容器的mergeddir文件夹：/var/lib/docker/geargraphdriver/containers/containerID/merged/

11. build文件夹：/var/lib/gear/build/
12. 每个镜像在build时的文件夹：/var/lib/gear/build/imageID/
13. 每个镜像在build时的普通文件存放的文件夹：/var/lib/gear/build/imageID/common/
14. 每个镜像在build时的非普通文件压缩包和dockerfile存放的文件夹：/var/lib/gear/build/imageID/build/

### gear registry指令

1. 目的：设置仓库节点，包括镜像仓库和存放OTC表的etcd实例
2. 实现：
-   1. 检测当前节点是否安装了docker
-   2. 启动registry容器作为私有仓库
-   3. 启动etcd实例
-   4. 返回有效信息，包括ip等

### gear peer指令

1. 目的：启动gear节点，将其加入到p2p网络中
2. 要求：配置文件
-   1. 
3. 实现：
-   

### gear build指令

1. 目标：将原docker镜像构建成gear镜像
2. docker镜像介绍：
-   docker镜像是一种分层镜像，在overlayfs中，每一层镜像拥有独立的目录，目录中有两个文件夹：diff和work，和两个文件：link和lower。
3. 设计：打破镜像层级结构，构建单一层的镜像，实现镜像之间的文件级别共享。同时使用overlayfs实现镜像的复用。
4. 实现：
-   1. 获取指定镜像所有层所在目录
-   2. 遍历这些目录，将所有普通文件拷贝到/var/lib/gear/build/imageID/common/目录，记录所有非普通文件
-   3. 将所有非普通文件打包成压缩包，存放在/var/lib/gear/build/imageID/uncommon/目录
-   4. 构建dockerfile文件，存放在/var/lib/gear/build/imageID/目录
-   5. 构建指定镜像的gear版本，命名规则为imageName-gear:tag

### gear push命令

1. 目标：将gear镜像的index镜像push到registry，普通文件push到nfs中
2. 实现：
-   1. 调用docker api将index镜像push到私有rigistry
-   2. 将镜像名imageID+文件相对于/var/lib/gear/build/imageID/common/的目录名组成的字符串做hash，得到OID（objectID），再对每个普通文件做hash，得到CID（contentID），将OID和CID配对存储到etcd中
-   3. 将每个普通文件改名为CID，并将其存储到NFS中

### gear graphdriver中的pull流程

1. 
















